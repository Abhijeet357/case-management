{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .task-card { transition: all 0.2s ease-in-out; border-left-width: 4px; }
    .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .priority-High { border-left-color: #dc3545; }
    .priority-Medium { border-left-color: #ffc107; }
    .priority-Low { border-left-color: #198754; }
    .stat-card { text-align: center; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Dashboard</h2>

    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-tasks-tab" data-bs-toggle="tab" data-bs-target="#my-tasks" type="button" role="tab">
                <i class="fas fa-user-check me-1"></i> My Action Items <span class="badge bg-danger ms-1">{{ my_own_tasks|length }}</span>
            </button>
        </li>
        {% if has_subordinates %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="team-workflow-tab" data-bs-toggle="tab" data-bs-target="#team-workflow" type="button" role="tab">
                <i class="fas fa-users me-1"></i> Team Workflow
            </button>
        </li>
        {% endif %}
        {% if show_overall_stats %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                <i class="fas fa-chart-pie me-1"></i> Overall Stats
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="my-tasks" role="tabpanel">
            <div class="py-4">
                {% if my_own_tasks %}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        {% for task in my_own_tasks %}
                        <div class="col">
                            <div class="card h-100 task-card priority-{{ task.priority }}">
                                <div class="card-header d-flex justify-content-between"><span>{{ task.title }}</span></div>
                                <div class="card-body"><p class="card-text">{{ task.description }}</p></div>
                                <div class="card-footer bg-white border-top-0 text-end">
                                    {% if task.type == 'case' %}<a href="{% url 'case_detail' task.object.case_id %}" class="btn btn-primary btn-sm">View Case</a>
                                    {% elif task.type == 'grievance' %}<a href="{% url 'take_grievance_action' task.object.grievance_id %}" class="btn btn-danger btn-sm">Take Action</a>
                                    {% elif task.type == 'approval' %}<a href="#" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#approvalModal" data-req-id="{{ task.object.id }}" data-action="approve">Approve</a> <a href="#" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#approvalModal" data-req-id="{{ task.object.id }}" data-action="reject">Reject</a>
                                    {% elif task.type == 'handover' %}<a href="#" class="btn btn-warning btn-sm text-dark" data-bs-toggle="modal" data-bs-target="#handoverModal" data-req-id="{{ task.object.id }}">Handover</a>
                                    {% elif task.type == 'acknowledgment' %}<a href="#" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#acknowledgeModal" data-req-id="{{ task.object.id }}">Acknowledge</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5"><i class="fas fa-check-circle fa-3x text-success mb-3"></i><h4>You have no pending action items.</h4></div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="team-workflow" role="tabpanel">
            <div class="py-4">
                <h5>Pending Tasks with Subordinates (Summary)</h5>
                <ul class="list-group mb-4">
                    {% for assignee, count in team_summary.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ assignee }}
                            <span class="badge bg-primary rounded-pill">{{ count }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item">Your team has no pending tasks.</li>
                    {% endfor %}
                </ul>

                {% if is_senior_officer and team_detailed_tasks %}
                    <hr>
                    <h5>Detailed View</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead><tr><th>Item Type</th><th>ID</th><th>Assigned To</th><th>Action</th></tr></thead>
                            <tbody>
                                {% for task in team_detailed_tasks %}
                                <tr>
                                    <td>{{ task.type }}</td>
                                    <td>
                                        {% if task.type == 'Case' %}
                                            {{ task.object.case_id }}
                                        {% elif task.type == 'Grievance' %}
                                            {{ task.object.grievance_id }}
                                        {% endif %}
                                        </td>
                                    <td>{{ task.holder.user.username }} ({{ task.holder.role }})</td>
                                    <td>
                                        {% if task.type == 'Case' %}
                                            <a href="{% url 'case_detail' task.object.case_id %}" class="btn btn-sm btn-outline-secondary">View Case</a>
                                        {% elif task.type == 'Grievance' %}
                                            <a href="{% url 'take_grievance_action' task.object.grievance_id %}" class="btn btn-sm btn-outline-secondary">View Grievance</a>
                                        {% endif %}
                                        </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="stats" role="tabpanel">
             <div class="py-4">
                <div class="row mb-4">
                    <div class="col-md-4"><div class="card bg-primary text-white text-center"><div class="card-body"><h4>{{ total_cases_stats }}</h4><p class="mb-0">Total Cases</p></div></div></div>
                    <div class="col-md-4"><div class="card bg-warning text-dark text-center"><div class="card-body"><h4>{{ pending_cases_stats }}</h4><p class="mb-0">Pending</p></div></div></div>
                    <div class="col-md-4"><div class="card bg-danger text-white text-center"><div class="card-body"><h4>{{ overdue_cases_stats }}</h4><p class="mb-0">Overdue</p></div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="approvalModal" tabindex="-1"><div class="modal-dialog"><form id="approvalForm" method="post"><div class="modal-content">{% csrf_token %}<div class="modal-header"><h5 class="modal-title" id="approvalModalTitle">Confirm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="approvalModalText">Are you sure?</p><input type="hidden" name="action" id="approvalActionInput"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn" id="approvalSubmitBtn">Confirm</button></div></div></form></div></div>
<div class="modal fade" id="handoverModal" tabindex="-1"><div class="modal-dialog"><form id="handoverForm" method="post"><div class="modal-content">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">Confirm Handover</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Confirm you are physically handing over the records.</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-warning text-dark">Confirm</button></div></div></form></div></div>
<div class="modal fade" id="acknowledgeModal" tabindex="-1"><div class="modal-dialog"><form id="acknowledgeForm" method="post"><div class="modal-content">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">Acknowledge Return</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Confirm you have physically received the returned records.</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-info">Acknowledge</button></div></div></form></div></div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Logic for the action modals (This code is correct and doesn't need changes)
    $('#approvalModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var reqId = button.data('req-id');
        var action = button.data('action');
        var url = "/records/requisition/" + reqId + "/action/";
        var modal = $(this);
        modal.find('#approvalForm').attr('action', url);
        modal.find('#approvalActionInput').val(action);
        if (action === 'approve') {
            modal.find('#approvalModalTitle').text('Confirm Approval');
            modal.find('#approvalModalText').text('Are you sure you want to approve this request?');
            modal.find('#approvalSubmitBtn').removeClass('btn-danger').addClass('btn-success').text('Approve');
        } else {
            modal.find('#approvalModalTitle').text('Confirm Rejection');
            modal.find('#approvalModalText').text('Are you sure you want to reject this request?');
            modal.find('#approvalSubmitBtn').removeClass('btn-success').addClass('btn-danger').text('Reject');
        }
    });
    $('#handoverModal').on('show.bs.modal', function (event) {
        var reqId = $(event.relatedTarget).data('req-id');
        $(this).find('#handoverForm').attr('action', "/records/requisition/" + reqId + "/handover/");
    });
    $('#acknowledgeModal').on('show.bs.modal', function (event) {
        var reqId = $(event.relatedTarget).data('req-id');
        $(this).find('#acknowledgeForm').attr('action', "/records/requisition/" + reqId + "/acknowledge-return/");
    });
});
</script>
{% endblock %}