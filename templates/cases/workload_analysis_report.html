<!-- templates/cases/workload_analysis_report.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Workload Analysis Report{% endblock %}

{% block extra_css %}
<style>
/* These styles help visualize workload levels through colors and animations */
.workload-card {
    border-radius: 12px;
    transition: all 0.3s ease;
    border-left: 5px solid transparent;
}

.workload-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Color coding for different workload levels - this helps managers quickly identify issues */
.workload-light { border-left-color: #28a745; background: linear-gradient(135deg, #d4edda, #c3e6cb); }
.workload-normal { border-left-color: #17a2b8; background: linear-gradient(135deg, #d1ecf1, #bee5eb); }  
.workload-heavy { border-left-color: #ffc107; background: linear-gradient(135deg, #fff3cd, #ffe69c); }
.workload-critical { border-left-color: #dc3545; background: linear-gradient(135deg, #f8d7da, #f1b0b7); }

.team-stats {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
    color: white;
    border-radius: 15px;
}

.metric-highlight {
    font-size: 2rem;
    font-weight: bold;
    color: #495057;
}

.workload-meter {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    background: #e9ecef;
}

.workload-fill {
    height: 100%;
    transition: width 0.8s ease;
    border-radius: 4px;
}

.comparison-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section - Explains what this report does and why it's useful -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'reports_dashboard' %}">Reports</a></li>
                    <li class="breadcrumb-item active">Workload Analysis</li>
                </ol>
            </nav>
            <h2><i class="fas fa-balance-scale me-2 text-primary"></i>Team Workload Analysis</h2>
            <p class="text-muted mb-0">Monitor work distribution and identify team members who may need support or rebalancing</p>
        </div>
        <div>
            <button class="btn btn-success" onclick="exportWorkloadReport()">
                <i class="fas fa-download me-2"></i>Export Report
            </button>
            <button class="btn btn-info ms-2" onclick="generateRecommendations()">
                <i class="fas fa-lightbulb me-2"></i>Get Recommendations
            </button>
        </div>
    </div>

    <!-- Team Overview Statistics - This gives managers the big picture at a glance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card team-stats">
                <div class="card-body">
                    <h5 class="text-white mb-3"><i class="fas fa-users me-2"></i>Team Performance Overview</h5>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="metric-highlight text-white">{{ team_averages.avg_current_cases }}</div>
                            <p class="mb-0 opacity-90">Average Cases per Person</p>
                            <small class="opacity-75">Current workload baseline</small>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-highlight text-white">{{ team_averages.avg_completed }}</div>
                            <p class="mb-0 opacity-90">Average Monthly Completions</p>
                            <small class="opacity-75">Productivity measure</small>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-highlight text-white">{{ team_averages.avg_workload_score }}</div>
                            <p class="mb-0 opacity-90">Average Workload Score</p>
                            <small class="opacity-75">Weighted complexity measure</small>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-highlight text-white">{{ workload_data|length }}</div>
                            <p class="mb-0 opacity-90">Active Team Members</p>
                            <small class="opacity-75">Currently handling cases</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Team Member Analysis - The heart of this report -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Individual Workload Analysis</h5>
                    <small class="text-muted">Sorted by workload score (highest workload first) - Click on cards for detailed recommendations</small>
                </div>
                <div class="card-body">
                    {% if workload_data %}
                        <div class="row g-4">
                            {% for member_data in workload_data %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card workload-card workload-{{ member_data.level_class }} h-100" 
                                     onclick="showMemberDetails('{{ member_data.member.user.username }}', {{ member_data.workload_score }}, '{{ member_data.workload_level }}')"
                                     style="cursor: pointer;">
                                    <div class="card-body">
                                        <!-- Member identification -->
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h6 class="mb-1">{{ member_data.member.user.get_full_name|default:member_data.member.user.username }}</h6>
                                                <small class="text-muted">{{ member_data.member.role }}</small>
                                            </div>
                                            <span class="badge bg-{{ member_data.level_class }} text-white">{{ member_data.workload_level }}</span>
                                        </div>

                                        <!-- Workload visualization bar -->
                                        <div class="workload-meter mb-3">
                                            <div class="workload-fill bg-{{ member_data.level_class }}" 
                                                 style="width: {% widthratio member_data.workload_score 30 100 %}%"></div>
                                        </div>

                                        <!-- Key metrics in an easy-to-scan format -->
                                        <div class="row text-center small">
                                            <div class="col-6">
                                                <div class="fw-bold text-primary">{{ member_data.current_cases }}</div>
                                                <div class="text-muted">Current Cases</div>
                                            </div>
                                            <div class="col-6">
                                                <div class="fw-bold text-success">{{ member_data.completed_this_month }}</div>
                                                <div class="text-muted">Completed</div>
                                            </div>
                                        </div>

                                        {% if member_data.assigned_grievances > 0 %}
                                        <div class="row text-center small mt-2">
                                            <div class="col-6">
                                                <div class="fw-bold text-warning">{{ member_data.assigned_grievances }}</div>
                                                <div class="text-muted">Grievances</div>
                                            </div>
                                            {% if member_data.pending_approvals > 0 %}
                                            <div class="col-6">
                                                <div class="fw-bold text-info">{{ member_data.pending_approvals }}</div>
                                                <div class="text-muted">Approvals</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- Workload score prominently displayed -->
                                        <div class="text-center mt-3">
                                            <small class="text-muted">Workload Score:</small>
                                            <div class="fw-bold" style="font-size: 1.2rem;">{{ member_data.workload_score|floatformat:1 }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No team members found</h5>
                            <p class="text-muted">Check if users are properly configured with active holder status.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis and Recommendations Section - Helps managers take action -->
    <div class="comparison-section mt-4">
        <h5 class="text-primary mb-3"><i class="fas fa-chart-bar me-2"></i>Workload Distribution Analysis</h5>
        
        <div class="row">
            <!-- Workload Level Distribution -->
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Team Distribution by Workload Level</h6>
                    </div>
                    <div class="card-body">
                        {% with light_count=0 normal_count=0 heavy_count=0 critical_count=0 %}
                            {% for member_data in workload_data %}
                                {% if member_data.workload_level == 'Light' %}
                                    {% with light_count=light_count|add:1 %}{% endwith %}
                                {% elif member_data.workload_level == 'Normal' %}
                                    {% with normal_count=normal_count|add:1 %}{% endwith %}
                                {% elif member_data.workload_level == 'Heavy' %}
                                    {% with heavy_count=heavy_count|add:1 %}{% endwith %}
                                {% elif member_data.workload_level == 'Critical' %}
                                    {% with critical_count=critical_count|add:1 %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}

                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-circle text-success me-2"></i>Light Workload</span>
                                <span class="fw-bold">{% for member_data in workload_data %}{% if member_data.workload_level == 'Light' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-circle text-info me-2"></i>Normal Workload</span>
                                <span class="fw-bold">{% for member_data in workload_data %}{% if member_data.workload_level == 'Normal' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-circle text-warning me-2"></i>Heavy Workload</span>
                                <span class="fw-bold">{% for member_data in workload_data %}{% if member_data.workload_level == 'Heavy' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-circle text-danger me-2"></i>Critical Workload</span>
                                <span class="fw-bold">{% for member_data in workload_data %}{% if member_data.workload_level == 'Critical' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actionable Insights -->
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Recommended Actions</h6>
                    </div>
                    <div class="card-body">
                        {% for member_data in workload_data %}
                            {% if member_data.workload_level == 'Critical' %}
                                <div class="alert alert-danger py-2 mb-2">
                                    <strong>{{ member_data.member.user.username }}</strong> is critically overloaded. Consider immediate redistribution.
                                </div>
                            {% elif member_data.workload_level == 'Heavy' %}
                                <div class="alert alert-warning py-2 mb-2">
                                    <strong>{{ member_data.member.user.username }}</strong> has heavy workload. Monitor closely for burnout.
                                </div>
                            {% elif member_data.workload_level == 'Light' %}
                                <div class="alert alert-success py-2 mb-2">
                                    <strong>{{ member_data.member.user.username }}</strong> can take on additional cases.
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="text-muted">No specific actions required at this time.</p>
                        {% endfor %}
                        
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="suggestRebalancing()">
                                <i class="fas fa-balance-scale me-2"></i>Suggest Case Rebalancing
                            </button>
                            <button class="btn btn-info btn-sm" onclick="scheduleReview()">
                                <i class="fas fa-calendar me-2"></i>Schedule Team Review
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Understanding the Metrics - Educational component to help users interpret the data -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Understanding Workload Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Workload Score Calculation</h6>
                            <p class="small text-muted">
                                The workload score is calculated as: <br>
                                <code>(Current Cases × 1.0) + (Grievances × 0.8) + (Approvals × 0.5)</code><br>
                                This weighted approach considers that cases require full attention, grievances are moderately complex, and approvals are quicker tasks.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Workload Levels</h6>
                            <ul class="small text-muted">
                                <li><strong>Light (0-5):</strong> Can take additional work</li>
                                <li><strong>Normal (6-15):</strong> Optimal workload range</li>
                                <li><strong>Heavy (16-25):</strong> Monitor for stress signs</li>
                                <li><strong>Critical (25+):</strong> Immediate attention needed</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Using This Report</h6>
                            <p class="small text-muted">
                                Review this report weekly to ensure balanced workload distribution. Look for patterns over time and consider seasonal variations. Use the recommendations to proactively manage team stress and productivity.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for detailed member information -->
<div class="modal fade" id="memberDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Team Member Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="memberDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="suggestActionsForMember()">Suggest Actions</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript functions to make the report interactive and helpful

let currentMember = null;

function showMemberDetails(username, workloadScore, workloadLevel) {
    currentMember = { username, workloadScore, workloadLevel };
    
    const content = `
        <div class="row">
            <div class="col-12">
                <h6>${username}</h6>
                <p><strong>Workload Level:</strong> <span class="badge bg-${getWorkloadColor(workloadLevel)}">${workloadLevel}</span></p>
                <p><strong>Workload Score:</strong> ${workloadScore}</p>
                
                <h6>Recommended Actions:</h6>
                <ul>
                    ${getRecommendations(workloadLevel, workloadScore)}
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('memberDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('memberDetailsModal')).show();
}

function getWorkloadColor(level) {
    const colors = {
        'Light': 'success',
        'Normal': 'info', 
        'Heavy': 'warning',
        'Critical': 'danger'
    };
    return colors[level] || 'secondary';
}

function getRecommendations(level, score) {
    switch(level) {
        case 'Critical':
            return `
                <li>Immediately reassign 2-3 cases to lighter-loaded team members</li>
                <li>Schedule one-on-one discussion about workload management</li>
                <li>Consider temporary assistance or deadline extensions</li>
                <li>Monitor daily for stress indicators</li>
            `;
        case 'Heavy':
            return `
                <li>Review case complexity and consider reassigning most complex cases</li>
                <li>Provide additional support or resources</li>
                <li>Avoid assigning new high-priority cases temporarily</li>
                <li>Check in weekly on progress and wellbeing</li>
            `;
        case 'Normal':
            return `
                <li>Current workload is optimal - maintain current assignments</li>
                <li>Can occasionally take urgent cases from overloaded colleagues</li>
                <li>Good candidate for mentoring junior team members</li>
            `;
        case 'Light':
            return `
                <li>Can take 2-3 additional cases immediately</li>
                <li>Good candidate for complex or research-intensive cases</li>
                <li>Consider for special projects or training opportunities</li>
                <li>May be able to assist overloaded team members</li>
            `;
        default:
            return '<li>No specific recommendations available</li>';
    }
}

function exportWorkloadReport() {
    // Generate CSV content with comprehensive workload data
    let csv = 'Name,Role,Current Cases,Completed This Month,Assigned Grievances,Pending Approvals,Workload Score,Workload Level\n';
    
    // Extract data from the DOM elements
    const cards = document.querySelectorAll('.workload-card');
    cards.forEach(card => {
        const name = card.querySelector('h6').textContent.trim();
        const role = card.querySelector('.text-muted').textContent.trim();
        const metrics = card.querySelectorAll('.fw-bold');
        const level = card.querySelector('.badge').textContent.trim();
        const score = card.querySelector('[style*="font-size: 1.2rem"]').textContent.trim();
        
        // Build row data safely
        const rowData = [
            name, role,
            metrics[0]?.textContent || '0',
            metrics[1]?.textContent || '0', 
            metrics[2]?.textContent || '0',
            metrics[3]?.textContent || '0',
            score, level
        ];
        
        csv += rowData.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Create and download the file
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'workload_analysis_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function generateRecommendations() {
    alert('Analyzing workload patterns and generating recommendations...\n\nThis feature will provide:\n• Suggested case redistributions\n• Optimal team size calculations\n• Training recommendations\n• Resource allocation suggestions');
}

function suggestRebalancing() {
    alert('Case Rebalancing Suggestions:\n\n1. Move 2 cases from critical workload members to light workload members\n2. Redistribute grievances based on expertise areas\n3. Consider deadline extensions for overloaded members\n4. Schedule daily check-ins for critical workload cases');
}

function scheduleReview() {
    alert('Recommended Review Actions:\n\n• Schedule weekly team meetings\n• Set up one-on-one sessions with overloaded members\n• Plan workload distribution review every 2 weeks\n• Create escalation procedures for workload issues');
}

function suggestActionsForMember() {
    if (currentMember) {
        alert(`Specific actions for ${currentMember.username}:\n\nBased on ${currentMember.workloadLevel} workload level, consider the recommended actions shown in the modal.`);
    }
}

// Initialize the page with helpful interactions
$(document).ready(function() {
    // Add tooltips to help users understand the interface
    $('[title]').tooltip();
    
    // Animate the workload bars for visual appeal
    $('.workload-fill').each(function() {
        const width = $(this).css('width');
        $(this).css('width', '0%').animate({width: width}, 1000);
    });
    
    // Refresh data every 10 minutes to keep workload information current
    setTimeout(function() {
        location.reload();
    }, 600000); // 10 minutes
});
</script>
{% endblock %}