{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Register New Grievance{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Register New Grievance</h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                <h5 class="mb-3">Step 1: Fetch Pensioner Details</h5>
                <div class="mb-3">
                    <label for="id_ppo_number" class="form-label">{{ form.ppo_number.label }}</label>
                    <div class="input-group">
                        <input type="text" name="ppo_number" class="form-control" placeholder="Enter PPO Number..." id="id_ppo_number" maxlength="20">
                        <button type="button" class="btn btn-info btn-sm" id="fetch-ppo-details-btn"> <i class="fas fa-search me-1"></i>Fetch
                        </button>
                </div>
                    <small class="form-text text-muted">{{ form.ppo_number.help_text }}</small>
</div>
                        </div>
                        <div id="ppo-status-message" class="mb-3"></div>

                        <div id="fetched-details-container" style="display: none;">
                            <h5 class="mb-3">Step 2: Verify Fetched Information</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">{{ form.pensioner_type|as_crispy_field }}</div>
                                <div class="col-md-6 mb-3">{{ form.date_of_retirement|as_crispy_field }}</div>
                                <div class="col-md-6 mb-3">{{ form.pension_type|as_crispy_field }}</div>
                                <div class="col-md-6 mb-3">{{ form.date_of_death|as_crispy_field }}</div>
                            </div>
                        </div>

                        <h5 class="mb-3">Step 3: Enter Grievance Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ form.complainant_name|as_crispy_field }}</div>
                            <div class="col-md-6 mb-3">{{ form.registered_contact|as_crispy_field }}</div>
                        </div>
                        <div class="mb-3">{{ form.complainant_contact|as_crispy_field }}</div>
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ form.mode_of_receipt|as_crispy_field }}</div>
                            <div class="col-md-6 mb-3">{{ form.date_received|as_crispy_field }}</div>
                        </div>
                        <div class="mb-3">{{ form.assigned_to|as_crispy_field }}</div>
                        <div class="mb-4">{{ form.grievance_text|as_crispy_field }}</div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Register Grievance</button>
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary"><i class="fas fa-times me-1"></i>Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#fetch-ppo-details-btn').on('click', function(e) {
        e.preventDefault();
        
        // --- 1. Get references to all our form fields ---
        var ppoNumber = $('#id_ppo_number').val().trim();
        var statusDiv = $('#ppo-status-message');
        var detailsContainer = $('#fetched-details-container');
        
        // Editable fields
        var nameField = $('#id_complainant_name');
        var contactField = $('#id_complainant_contact');

        // Read-only display fields
        var registeredContactField = $('#id_registered_contact');
        var pensionerTypeField = $('#id_pensioner_type');
        var retirementDateField = $('#id_date_of_retirement');
        var pensionTypeField = $('#id_pension_type');
        var deathDateField = $('#id_date_of_death');

        if (!ppoNumber) {
            statusDiv.html('<div class="alert alert-warning">Please enter a PPO number.</div>');
            return;
        }

        // --- 2. Show loading state ---
        statusDiv.html('<div class="alert alert-info">Fetching details...</div>');
        detailsContainer.hide(); // Hide the details section while loading
        var $fetchBtn = $(this);
        $fetchBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Fetching...');

        // --- 3. Make the AJAX call ---
        $.ajax({
            url: "{% url 'get_ppo_data' %}",
            method: 'GET',
            data: { 'ppo_number': ppoNumber },
            success: function(response) {
                if (response.success && response.data) {
                    var data = response.data;
                    
                    // --- 4. Populate ALL the fields with the fetched data ---
                    nameField.val(data.employee_name || '').prop('readonly', false);
                    registeredContactField.val(data.mobile_number || 'Not available');
                    
                    // Populate the new read-only fields
                    pensionerTypeField.val(data.pensioner_type || 'N/A');
                    retirementDateField.val(data.date_of_retirement || 'N/A');
                    pensionTypeField.val(data.pension_type || 'N/A');
                    deathDateField.val(data.date_of_death || 'N/A');
                    
                    // Show the container with the fetched details
                    detailsContainer.slideDown(); 
                    statusDiv.html('<div class="alert alert-success">Pensioner details loaded for <strong>' + data.employee_name + '</strong>.</div>');
                } else {
                    // Handle case where PPO is not found
                    statusDiv.html('<div class="alert alert-warning">' + (response.error || 'PPO not found.') + '</div>');
                    detailsContainer.slideUp();
                }
            },
            error: function() {
                // Handle server or network errors
                statusDiv.html('<div class="alert alert-danger">An error occurred while fetching data.</div>');
                detailsContainer.slideUp();
            },
            complete: function() {
                // Reset the button state
                $fetchBtn.prop('disabled', false).html('<i class="fas fa-search me-1"></i>Fetch Details');
            }
        });
    });
});
</script>
{% endblock %}