{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Register New Case{% endblock %}

{% block content %}

<h2>Register New Case</h2>

<form method="post" id="case-form">
    {% csrf_token %}
    
    <!-- Common fields -->
    <div class="row">
        <div class="col-md-6">{{ form.case_type|as_crispy_field }}</div>
    </div>
    <div class="row">
        <div class="col-md-6">{{ form.priority|as_crispy_field }}</div>
    </div>
    {{ form.initial_holder|as_crispy_field }}
    
    <!-- Conditional field groups -->
    <div id="know-your-pensioner-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.mode_of_receipt|as_crispy_field }}
    </div>
    
    <div id="family-pension-death-in-service-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fp" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fp" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="family-pension-extended-family-pension-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-efp" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-efp" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="life-time-arrears-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-lta" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-lta" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="ppo-correction-fields" class="specific-fields" style="display: none;">
        {{ form.type_of_correction|as_crispy_field }}
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-pc" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-pc" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.original_ppo_submitted|as_crispy_field }}
    </div>
    
    <div id="superannuation-fields" class="specific-fields" style="display: none;">
        {{ form.retirement_month|as_crispy_field }}
        {{ form.retirement_year|as_crispy_field }}
        {{ form.fresh_or_compliance|as_crispy_field }}
        {{ form.type_of_employee|as_crispy_field }}
        {{ form.retiring_employee|as_crispy_field }}
        {{ form.date_of_retirement|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="fixed-medical-allowance-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fma" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fma" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="death-intimation-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-di" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-di" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.type_of_pension|as_crispy_field }}
        {{ form.type_of_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="family-pension-conversion-of-superannuation-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fpcs" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fpcs" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.type_of_pension|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <button type="submit" class="btn btn-primary">Done</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    console.log('Document ready - initializing simplified form handlers');
    
    // Show/hide fields based on case type
    $('#id_case_type').change(function() {
        var selectedText = $('option:selected', this).text().trim().toLowerCase().replace(/ \(.+\)/g, '').replace(/ /g, '-').replace(/-+/g, '-');
        console.log('Selected case type ID:', selectedText);
        $('.specific-fields').hide();
        $('#' + selectedText + '-fields').show();
    });
    
    // Enhanced PPO data fetcher with improved field detection
    function fetchPPOData(ppoInputId, statusDivId) {
        var ppoNumber = $(ppoInputId).val().trim();
        console.log('Fetching PPO data for:', ppoNumber);
        
        if (!ppoNumber) {
            $(statusDivId).html('<div class="alert alert-warning">Please enter a PPO number</div>');
            return;
        }
        
        $(statusDivId).html('<div class="alert alert-info">Fetching PPO data...</div>');
        
        $.ajax({
            url: '{% url "get_ppo_data" %}',
            type: 'GET',
            data: { ppo_number: ppoNumber },
            success: function(response) {
                console.log('PPO API response:', response);
                
                if (response.success && response.data) {
                    var data = response.data;
                    var updatedFields = [];
                    var manualEntryNeeded = [];
                    
                    // Get the currently visible form section
                    var visibleSection = $('.specific-fields:visible');
                    console.log('Visible section:', visibleSection.attr('id'));
                    
                    // Update name field - look only in visible section first, then globally
                    var nameField = null;
                    if (visibleSection.length > 0) {
                        nameField = visibleSection.find('#id_name_pensioner, [name="name_pensioner"]').first();
                    }
                    if (!nameField || nameField.length === 0) {
                        nameField = $('#id_name_pensioner, [name="name_pensioner"]').first();
                    }
                    
                    if (nameField.length > 0) {
                        if (data.name_pensioner && data.name_pensioner.trim()) {
                            console.log('Found name field:', nameField);
                            nameField.val(data.name_pensioner.trim());
                            nameField.trigger('change');
                            nameField.trigger('input');
                            updatedFields.push('Name: ' + data.name_pensioner);
                            console.log('Updated name field with:', data.name_pensioner);
                            nameField.addClass('field-updated');
                        } else {
                            // Enable field for manual entry and add placeholder
                            nameField.attr('placeholder', 'Please enter pensioner name manually');
                            nameField.addClass('manual-entry-required');
                            manualEntryNeeded.push('Pensioner Name');
                            console.log('Name not available in database - allowing manual entry');
                        }
                    }
                    
                    // Update retirement date field - look only in visible section first, then globally
                    var dateField = null;
                    if (visibleSection.length > 0) {
                        dateField = visibleSection.find('#id_date_of_retirement, [name="date_of_retirement"]').first();
                    }
                    if (!dateField || dateField.length === 0) {
                        dateField = $('#id_date_of_retirement, [name="date_of_retirement"]').first();
                    }
                    
                    if (dateField.length > 0) {
                        if (data.date_of_retirement && data.date_of_retirement.trim()) {
                            console.log('Found date field:', dateField);
                            dateField.val(data.date_of_retirement);
                            dateField.trigger('change');
                            dateField.trigger('input');
                            updatedFields.push('Retirement Date: ' + data.date_of_retirement);
                            console.log('Updated date field with:', data.date_of_retirement);
                            dateField.addClass('field-updated');
                        } else {
                            // Enable field for manual entry and add placeholder
                            dateField.attr('placeholder', 'YYYY-MM-DD');
                            dateField.addClass('manual-entry-required');
                            manualEntryNeeded.push('Retirement Date');
                            console.log('Retirement date not available in database - allowing manual entry');
                        }
                    }
                    
                    // Update mobile number if available and field exists
                    var mobileField = null;
                    if (visibleSection.length > 0) {
                        mobileField = visibleSection.find('#id_mobile_number, [name="mobile_number"]').first();
                    }
                    if (!mobileField || mobileField.length === 0) {
                        mobileField = $('#id_mobile_number, [name="mobile_number"]').first();
                    }
                    
                    if (mobileField.length > 0) {
                        if (data.mobile_number && data.mobile_number.trim()) {
                            console.log('Found mobile field:', mobileField);
                            mobileField.val(data.mobile_number);
                            mobileField.trigger('change');
                            mobileField.trigger('input');
                            updatedFields.push('Mobile: ' + data.mobile_number);
                            console.log('Updated mobile field with:', data.mobile_number);
                            mobileField.addClass('field-updated');
                        } else {
                            // Enable field for manual entry and add placeholder
                            mobileField.attr('placeholder', 'Enter mobile number');
                            mobileField.addClass('manual-entry-required');
                            manualEntryNeeded.push('Mobile Number');
                            console.log('Mobile number not available in database - allowing manual entry');
                        }
                    }
                    
                    // Update pension type if available and field exists
                    var pensionTypeField = null;
                    if (visibleSection.length > 0) {
                        pensionTypeField = visibleSection.find('#id_type_of_pension, [name="type_of_pension"]').first();
                    }
                    if (!pensionTypeField || pensionTypeField.length === 0) {
                        pensionTypeField = $('#id_type_of_pension, [name="type_of_pension"]').first();
                    }
                    
                    if (pensionTypeField.length > 0) {
                        if (data.type_of_pension && data.type_of_pension.trim()) {
                            console.log('Found pension type field:', pensionTypeField);
                            pensionTypeField.val(data.type_of_pension);
                            pensionTypeField.trigger('change');
                            updatedFields.push('Pension Type: ' + data.type_of_pension);
                            console.log('Updated pension type field with:', data.type_of_pension);
                            pensionTypeField.addClass('field-updated');
                        } else {
                            // For dropdown fields, just highlight that manual selection is needed
                            pensionTypeField.addClass('manual-entry-required');
                            manualEntryNeeded.push('Pension Type');
                            console.log('Pension type not available in database - manual selection required');
                        }
                    }
                    
                    // Update date of death if available and field exists
                    var deathDateField = null;
                    if (visibleSection.length > 0) {
                        deathDateField = visibleSection.find('#id_date_of_death, [name="date_of_death"]').first();
                    }
                    if (!deathDateField || deathDateField.length === 0) {
                        deathDateField = $('#id_date_of_death, [name="date_of_death"]').first();
                    }
                    
                    if (deathDateField.length > 0) {
                        if (data.date_of_death && data.date_of_death.trim()) {
                            console.log('Found death date field:', deathDateField);
                            deathDateField.val(data.date_of_death);
                            deathDateField.trigger('change');
                            deathDateField.trigger('input');
                            updatedFields.push('Date of Death: ' + data.date_of_death);
                            console.log('Updated death date field with:', data.date_of_death);
                            deathDateField.addClass('field-updated');
                        } else {
                            // Enable field for manual entry and add placeholder
                            deathDateField.attr('placeholder', 'YYYY-MM-DD');
                            deathDateField.addClass('manual-entry-required');
                            manualEntryNeeded.push('Date of Death');
                            console.log('Date of death not available in database - allowing manual entry');
                        }
                    }
                    
                    // Show success message with information about what was updated and what needs manual entry
                    var message = '';
                    var messageClass = '';
                    
                    if (updatedFields.length > 0 && manualEntryNeeded.length > 0) {
                        message = 'PPO data partially fetched!<br><strong>Auto-filled:</strong> ' + updatedFields.join(', ') + 
                                '<br><strong>Please enter manually:</strong> ' + manualEntryNeeded.join(', ');
                        messageClass = 'alert-warning';
                    } else if (updatedFields.length > 0) {
                        message = 'PPO data fetched successfully!<br>' + updatedFields.join('<br>');
                        messageClass = 'alert-success';
                    } else if (manualEntryNeeded.length > 0) {
                        message = 'PPO found but some data is missing in database.<br><strong>Please enter manually:</strong> ' + manualEntryNeeded.join(', ');
                        messageClass = 'alert-info';
                    } else {
                        message = 'PPO found but no relevant fields found for this form section';
                        messageClass = 'alert-warning';
                    }
                    
                    $(statusDivId).html('<div class="alert ' + messageClass + '">' + message + '</div>');
                    
                    // Add visual feedback to updated fields
                    setTimeout(function() {
                        $('.field-updated').removeClass('field-updated');
                    }, 2000);
                    
                    // Keep manual entry highlighting longer
                    setTimeout(function() {
                        $('.manual-entry-required').removeClass('manual-entry-required');
                    }, 10000);
                    
                    // Auto-hide message after 5 seconds
                    setTimeout(function() {
                        $(statusDivId).fadeOut();
                    }, 5000);
                    
                } else {
                    console.error('API error:', response.error);
                    var errorMsg = response.error || 'No data found for this PPO number';
                    $(statusDivId).html('<div class="alert alert-danger">' + errorMsg + '</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', status, error);
                console.error('Response text:', xhr.responseText);
                $(statusDivId).html('<div class="alert alert-danger">Failed to fetch PPO data. Please try again. Error: ' + error + '</div>');
            }
        });
    }
    
    // Button to status div mapping
    var buttonToStatusMap = {
        'fetch-ppo-btn': '#ppo-status',
        'fetch-ppo-btn-fp': '#ppo-status-fp',
        'fetch-ppo-btn-efp': '#ppo-status-efp',
        'fetch-ppo-btn-lta': '#ppo-status-lta',
        'fetch-ppo-btn-pc': '#ppo-status-pc',
        'fetch-ppo-btn-fma': '#ppo-status-fma',
        'fetch-ppo-btn-di': '#ppo-status-di',
        'fetch-ppo-btn-fpcs': '#ppo-status-fpcs'
    };
    
    // Bind all PPO fetch buttons with improved error handling
    $('#fetch-ppo-btn, #fetch-ppo-btn-fp, #fetch-ppo-btn-efp, #fetch-ppo-btn-lta, #fetch-ppo-btn-pc, #fetch-ppo-btn-fma, #fetch-ppo-btn-di, #fetch-ppo-btn-fpcs').click(function(e) {
        e.preventDefault();
        
        var buttonId = $(this).attr('id');
        var statusDiv = buttonToStatusMap[buttonId] || '#ppo-status';
        
        console.log('PPO fetch button clicked:', buttonId, 'Status div:', statusDiv);
        
        // Find the PPO input field in the current visible section
        var visibleSection = $(this).closest('.specific-fields');
        var ppoInput = visibleSection.find('#id_ppo_number, [name="ppo_number"]').first();
        
        if (ppoInput.length === 0) {
            ppoInput = $('#id_ppo_number, [name="ppo_number"]').first();
        }
        
        if (ppoInput.length > 0) {
            console.log('Found PPO input field:', ppoInput);
            fetchPPOData('#' + ppoInput.attr('id'), statusDiv);
        } else {
            console.error('PPO input field not found');
            $(statusDiv).html('<div class="alert alert-danger">PPO input field not found</div>');
        }
    });
    
    // For Superannuation: Fetch retiring employees on month/year change
    $('#id_retirement_month, #id_retirement_year').change(function() {
        var month = $('#id_retirement_month').val();
        var year = $('#id_retirement_year').val();
        
        if (month && year) {
            $.get('/get-retiring-employees-by-month-year/', {month: month, year: year})
                .done(function(data) {
                    $('#id_retiring_employee').empty();
                    $('#id_retiring_employee').append('<option value="">Select Employee</option>');
                    $.each(data.employees, function(index, emp) {
                        $('#id_retiring_employee').append('<option value="' + emp.id + '">' + emp.name + '</option>');
                    });
                })
                .fail(function() {
                    console.warn('Failed to load retiring employees');
                });
        }
    });
    
    // Fetch retiring employee data (date)
    $('#id_retiring_employee').change(function() {
        var employeeId = $(this).val();
        
        if (employeeId) {
            $.get('/get-retiring-employee-data/', {employee_id: employeeId})
                .done(function(data) {
                    if (!data.error && data.retirement_date) {
                        $('#id_date_of_retirement').val(data.retirement_date);
                        $('#id_date_of_retirement').trigger('change');
                    }
                })
                .fail(function() {
                    console.warn('Failed to load retiring employee data');
                });
        }
    });
    
    // Trigger initial change
    $('#id_case_type').trigger('change');
});

// Add CSS for visual feedback
$('<style>')
    .prop('type', 'text/css')
    .html(`
        .field-updated {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            transition: all 0.3s ease;
        }
        
        .manual-entry-required {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            transition: all 0.3s ease;
        }
        
        .manual-entry-required::placeholder {
            color: #856404 !important;
            font-style: italic;
        }
        
        .alert {
            margin-top: 10px;
        }
        
        .alert strong {
            font-weight: bold;
        }
        
        .specific-fields {
            border-left: 3px solid #007bff;
            padding-left: 15px;
            margin-top: 20px;
        }
    `)
    .appendTo('head');

</script>

{% endblock %}