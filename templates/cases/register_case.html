{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Register New Case{% endblock %}

{% block content %}

<h2>Register New Case</h2>

<form method="post" id="case-form">
    {% csrf_token %}
    
    <!-- Common fields -->
    <div class="row">
        <div class="col-md-6">{{ form.case_type|as_crispy_field }}</div>
    </div>
    <div class="row">
        <div class="col-md-6">{{ form.priority|as_crispy_field }}</div>
    </div>
    {{ form.initial_holder|as_crispy_field }}
    
    <!-- Conditional field groups -->
    <div id="know-your-pensioner-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.mode_of_receipt|as_crispy_field }}
    </div>
    
    <div id="family-pension-death-in-service-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fp" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fp" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="family-pension-extended-family-pension-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-efp" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-efp" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="life-time-arrears-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-lta" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-lta" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="ppo-correction-fields" class="specific-fields" style="display: none;">
        {{ form.type_of_correction|as_crispy_field }}
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-pc" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-pc" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.original_ppo_submitted|as_crispy_field }}
    </div>
    
    <div id="superannuation-fields" class="specific-fields" style="display: none;">
        {{ form.retirement_month|as_crispy_field }}
        {{ form.retirement_year|as_crispy_field }}
        {{ form.fresh_or_compliance|as_crispy_field }}
        {{ form.type_of_employee|as_crispy_field }}
        {{ form.retiring_employee|as_crispy_field }}
        {{ form.date_of_retirement|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="fixed-medical-allowance-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fma" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fma" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
    </div>
    
    <div id="death-intimation-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-di" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-di" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.type_of_pension|as_crispy_field }}
        {{ form.type_of_pensioner|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <div id="family-pension-conversion-of-superannuation-fields" class="specific-fields" style="display: none;">
        {{ form.ppo_number|as_crispy_field }}
        <button type="button" id="fetch-ppo-btn-fpcs" class="btn btn-info btn-sm">Fetch PPO Data</button>
        <div id="ppo-status-fpcs" class="mt-2"></div>
        {{ form.name_pensioner|as_crispy_field }}
        {{ form.type_of_pension|as_crispy_field }}
        {{ form.date_of_death|as_crispy_field }}
        {{ form.name_claimant|as_crispy_field }}
        {{ form.relationship|as_crispy_field }}
        {{ form.mobile_number|as_crispy_field }}
        {{ form.service_book_enclosed|as_crispy_field }}
    </div>
    
    <button type="submit" class="btn btn-primary">Done</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    console.log('Document ready - initializing simplified form handlers');
    
    // Show/hide fields based on case type
    $('#id_case_type').change(function() {
        var selectedText = $('option:selected', this).text().trim().toLowerCase().replace(/ \(.+\)/g, '').replace(/ /g, '-').replace(/-+/g, '-');
        console.log('Selected case type ID:', selectedText);
        $('.specific-fields').hide();
        $('#' + selectedText + '-fields').show();
    });
    
    // Simplified PPO data fetcher - only name and retirement date
    function fetchPPOData(ppoInputId, statusDivId) {
        var ppoNumber = $(ppoInputId).val().trim();
        console.log('Fetching PPO data for:', ppoNumber);
        
        if (!ppoNumber) {
            $(statusDivId).html('<div class="alert alert-warning">Please enter a PPO number</div>');
            return;
        }
        
        $(statusDivId).html('<div class="alert alert-info">Fetching PPO data...</div>');
        
        $.ajax({
            url: '{% url "get_ppo_data" %}',
            type: 'GET',
            data: { ppo_number: ppoNumber },
            success: function(response) {
                console.log('PPO API response:', response);
                
                if (response.success && response.data) {
                    var data = response.data;
                    
                    // Only update name and retirement date
                    var nameField = $('#id_name_pensioner');
                    var retirementDateField = $('#id_date_of_retirement');
                    
                    var updatedFields = [];
                    
                    // Update pensioner name
                    if (nameField.length && data.name_pensioner) {
                        nameField.val(data.name_pensioner.trim());
                        updatedFields.push('Name: ' + data.name_pensioner);
                        console.log('Updated name field with:', data.name_pensioner);
                    }
                    
                    // Update retirement date
                    if (retirementDateField.length && data.date_of_retirement) {
                        retirementDateField.val(data.date_of_retirement);
                        updatedFields.push('Retirement Date: ' + data.date_of_retirement);
                        console.log('Updated retirement date field with:', data.date_of_retirement);
                    }
                    
                    // Show success message
                    if (updatedFields.length > 0) {
                        var successMsg = 'PPO data fetched successfully!<br>' + updatedFields.join('<br>');
                        $(statusDivId).html('<div class="alert alert-success">' + successMsg + '</div>');
                    } else {
                        $(statusDivId).html('<div class="alert alert-warning">PPO found but no name/retirement date available</div>');
                    }
                    
                    // Auto-hide message after 3 seconds
                    setTimeout(function() {
                        $(statusDivId).fadeOut();
                    }, 3000);
                    
                } else {
                    console.error('API error:', response.error);
                    var errorMsg = response.error || 'No data found for this PPO number';
                    $(statusDivId).html('<div class="alert alert-danger">' + errorMsg + '</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', status, error);
                $(statusDivId).html('<div class="alert alert-danger">Failed to fetch PPO data. Please try again.</div>');
            }
        });
    }
    
    // Bind all PPO fetch buttons to the same simplified function
    $('#fetch-ppo-btn, #fetch-ppo-btn-fp, #fetch-ppo-btn-efp, #fetch-ppo-btn-lta, #fetch-ppo-btn-pc, #fetch-ppo-btn-fma, #fetch-ppo-btn-di, #fetch-ppo-btn-fpcs').click(function(e) {
        e.preventDefault();
        
        // Find the corresponding status div based on button ID
        var buttonId = $(this).attr('id');
        var statusDiv = '#ppo-status';
        
        if (buttonId.includes('-fp')) statusDiv = '#ppo-status-fp';
        else if (buttonId.includes('-efp')) statusDiv = '#ppo-status-efp';
        else if (buttonId.includes('-lta')) statusDiv = '#ppo-status-lta';
        else if (buttonId.includes('-pc')) statusDiv = '#ppo-status-pc';
        else if (buttonId.includes('-fma')) statusDiv = '#ppo-status-fma';
        else if (buttonId.includes('-di')) statusDiv = '#ppo-status-di';
        else if (buttonId.includes('-fpcs')) statusDiv = '#ppo-status-fpcs';
        
        console.log('PPO fetch button clicked:', buttonId, 'Status div:', statusDiv);
        fetchPPOData('#id_ppo_number', statusDiv);
    });
    
    // For Superannuation: Fetch retiring employees on month/year change
    $('#id_retirement_month, #id_retirement_year').change(function() {
        var month = $('#id_retirement_month').val();
        var year = $('#id_retirement_year').val();
        
        if (month && year) {
            $.get('/get-retiring-employees-by-month-year/', {month: month, year: year})
                .done(function(data) {
                    $('#id_retiring_employee').empty();
                    $('#id_retiring_employee').append('<option value="">Select Employee</option>');
                    $.each(data.employees, function(index, emp) {
                        $('#id_retiring_employee').append('<option value="' + emp.id + '">' + emp.name + '</option>');
                    });
                })
                .fail(function() {
                    console.warn('Failed to load retiring employees');
                });
        }
    });
    
    // Fetch retiring employee data (date)
    $('#id_retiring_employee').change(function() {
        var employeeId = $(this).val();
        
        if (employeeId) {
            $.get('/get-retiring-employee-data/', {employee_id: employeeId})
                .done(function(data) {
                    if (!data.error && data.retirement_date) {
                        $('#id_date_of_retirement').val(data.retirement_date);
                    }
                })
                .fail(function() {
                    console.warn('Failed to load retiring employee data');
                });
        }
    });
    
    // Trigger initial change
    $('#id_case_type').trigger('change');
});

</script>

{% endblock %}