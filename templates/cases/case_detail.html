{% extends 'base.html' %}
{% load static %}

{% block title %}Case Details: {{ case.case_id }}{% endblock %}

{% block extra_css %}
<style>
    /* Styles for the milestone timeline */
    .timeline { list-style: none; padding: 0; position: relative; }
    .timeline:before {
        top: 0; bottom: 0; position: absolute; content: " "; width: 3px;
        background-color: #dee2e6; left: 25px; margin-left: -1.5px;
    }
    .timeline > li { margin-bottom: 20px; position: relative; }
    .timeline > li .timeline-panel {
        width: calc(100% - 75px); float: right; padding: 20px;
        border: 1px solid #d4d4d4; border-radius: 5px; position: relative;
    }
    .timeline > li .timeline-badge {
        color: #fff; width: 50px; height: 50px; line-height: 50px;
        text-align: center; position: absolute; top: 16px; left: 25px;
        margin-left: -25px; background-color: #999; z-index: 100;
        border-radius: 50%;
    }
    .timeline-badge.completed { background-color: #198754 !important; }
    .timeline-badge.overdue { background-color: #dc3545 !important; }
    .timeline-badge.pending { background-color: #6c757d !important; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Case Details: {{ case.case_id }}</h4>
                    <span class="badge 
                        {% if case.is_completed %}bg-success
                        {% elif case.expected_completion and case.expected_completion < now %}bg-danger
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ case.current_status }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6"><p><strong>Case Title:</strong> {{ case.case_title }}</p></div>
                        <div class="col-md-6"><p><strong>Current Holder:</strong> {{ case.current_holder.user.get_full_name|default:case.current_holder.user.username }}</p></div>
                        <div class="col-md-6"><p><strong>Priority:</strong> {{ case.priority }}</p></div>
                        <div class="col-md-6"><p><strong>Expected By:</strong> {{ case.expected_completion|date:"d M Y" }}</p></div>
                    </div>
                    <hr>
                    <h5>Actions</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        {% if not case.is_completed and user_profile == case.current_holder %}
                            <a href="{% url 'move_case' case.case_id %}" class="btn btn-primary"><i class="fas fa-arrow-right me-1"></i> Move Case</a>
                        {% endif %}
                        {% if user_profile.role == 'DH' %}
                            <a href="{% url 'request_record' case.case_id %}" class="btn btn-success"><i class="fas fa-file-import me-1"></i> Request Records</a>
                            <a href="{% url 'return_record' case.case_id %}" class="btn btn-info"><i class="fas fa-file-export me-1"></i> Return Records</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header"><h5><i class="fas fa-tasks me-2"></i>Milestone Progress</h5></div>
                <div class="card-body">
                    <ul class="timeline">
                        {% for progress in milestone_progress %}
                        <li>
                            <div class="timeline-badge {% if progress.status == 'completed' %}completed{% elif progress.expected_completion_date < now and progress.status != 'completed' %}overdue{% else %}pending{% endif %}">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-panel">
                                <h6>{{ progress.milestone.milestone_name }}</h6>
                                <p><strong>Status:</strong> {{ progress.get_status_display }}</p>
                            </div>
                        </li>
                        {% empty %}
                            <p>No milestones are set for this case type.</p>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header"><h5><i class="fas fa-history me-2"></i>Movement History</h5></div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for movement in movements %}
                        <li class="list-group-item">
                            <strong>{{ movement.action|title }}</strong>
                            <small class="text-muted d-block">To: {{ movement.to_holder.user.username }}</small>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No movement history found.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}